<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>FlexRL-vignette</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">FlexRL-vignette</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(FlexRL)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#&gt; If you are happy with FlexRL, please cite us! Also, if you are unhappy, please cite us anyway.</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">#&gt; HERE ADD</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">#&gt; bibtex format in CITATION.</span></span></code></pre></div>
<p><code>FlexRL</code> is an algorithm for <strong>R</strong>ecord
<strong>L</strong>inkage written in R and cpp. It uses a
<strong>St</strong>ochastic <strong>E</strong>xpectation
<strong>M</strong>aximisation approach to combine 2 data sources and
outputs the set of records referring to the same entities.</p>
<p>More details are provided in our <a href="https://arxiv.org/abs/2407.06835">paper</a>.</p>
<p>This vignette uses example subsets from the <a href="https://github.com/robachowyk/FlexRL-experiments/tree/main/SHIWApplication/SHIWData">SHIW</a>
data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>df2016 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">&quot;exA.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>df2020 <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">&quot;exB.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">head</span>(df2016)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt;   ANASCI SESSO STACIV STUDIO IREG       ID ANNO PAR NASCREG ETA</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt; 1   1953     1      1      2    2 501068_1 2016   1      19  63</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; 2   1960     2      1      2    2 501068_2 2016   2      19  56</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; 3   1955     1      1      3    2 501082_1 2016   1       2  61</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; 4   1958     2      1      4    2 501082_2 2016   2       2  58</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; 5   1961     2      1      3    2 680914_1 2016   1       2  55</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; 6   1965     1      1      3    2 680914_2 2016   2       2  51</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">head</span>(df2020)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt;   ANASCI SESSO STACIV STUDIO IREG       ID ANNO PAR NASCREG ETA</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; 1   1953     1      1      2    2 501068_1 2020   1      19  67</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; 2   1960     2      1      3    2 501068_2 2020   2      19  60</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; 3   1955     1      1      3    2 501082_1 2020   1       2  65</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; 4   1958     2      1      4    2 501082_2 2020   2       2  62</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; 5   1961     2      3      3    2 686717_1 2020   1      18  59</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; 6   1998     1      2      3    2 686717_4 2020   3       2  22</span></span></code></pre></div>
<p>We will use several <strong>P</strong>artially
<strong>I</strong>dentifying <strong>V</strong>ariable<strong>s</strong>
to link the records: birth year, sex, marital status, education level,
regional code. We treat them all as stable i.e. not evolving across time
(though it may not be true). We show an example with
<strong>PIVs</strong> that evolve over time later.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>PIVs_config <span class="ot">=</span> <span class="fu">list</span>( </span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="at">ANASCI     =</span> <span class="fu">list</span>(<span class="at">stable =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">SESSO      =</span> <span class="fu">list</span>(<span class="at">stable =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">STACIV     =</span> <span class="fu">list</span>(<span class="at">stable =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="at">STUDIO     =</span> <span class="fu">list</span>(<span class="at">stable =</span> <span class="cn">TRUE</span>), </span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">IREG       =</span> <span class="fu">list</span>(<span class="at">stable =</span> <span class="cn">TRUE</span>) </span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  )</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>PIVs <span class="ot">=</span> <span class="fu">names</span>(PIVs_config)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>PIVs_stable <span class="ot">=</span> <span class="fu">sapply</span>(PIVs_config, <span class="cf">function</span>(x) x<span class="sc">$</span>stable)</span></code></pre></div>
<p>A first step in record linkage is to remove the records for which the
linking variables are outside of the common support. If a record in the
first file indicates a birth year which does not appear in the second
file, we can suppose that this record has no link in the second
file.</p>
<p>We need to reinitialise the rownames to be used as indices later (to
compare the true pairs and the linked pairs for instance).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(PIVs)){</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  intersect_support_piv <span class="ot">=</span> <span class="fu">intersect</span>( <span class="fu">unique</span>(df2016[,PIVs[i]]), <span class="fu">unique</span>(df2020[,PIVs[i]]) )</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  df2016 <span class="ot">=</span> df2016[df2016[,PIVs[i]] <span class="sc">%in%</span> <span class="fu">c</span>(<span class="cn">NA</span>,intersect_support_piv),]</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  df2020 <span class="ot">=</span> df2020[df2020[,PIVs[i]] <span class="sc">%in%</span> <span class="fu">c</span>(<span class="cn">NA</span>,intersect_support_piv),]</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>}</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">rownames</span>(df2016) <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df2016)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="fu">rownames</span>(df2020) <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df2020)</span></code></pre></div>
<p>For these example data sets we know the true linkage structure.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>links <span class="ot">=</span> <span class="fu">intersect</span>(df2016<span class="sc">$</span>ID, df2020<span class="sc">$</span>ID)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>Nlinks <span class="ot">=</span> <span class="fu">length</span>(links)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>TrueDelta <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">0</span>, <span class="at">ncol=</span><span class="dv">2</span>) )</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Nlinks)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>{</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  id <span class="ot">=</span> links[i]</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  id16 <span class="ot">=</span> <span class="fu">which</span>(df2016<span class="sc">$</span>ID <span class="sc">==</span> id)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  id20 <span class="ot">=</span> <span class="fu">which</span>(df2020<span class="sc">$</span>ID <span class="sc">==</span> id)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  TrueDelta <span class="ot">=</span> <span class="fu">rbind</span>(TrueDelta, <span class="fu">cbind</span>(<span class="fu">rownames</span>(df2016[id16,]),<span class="fu">rownames</span>(df2020[id20,])))</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>}</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>true_pairs <span class="ot">=</span> <span class="fu">do.call</span>(paste, <span class="fu">c</span>(TrueDelta, <span class="fu">list</span>(<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">nrow</span>(df2016)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#&gt; [1] 49</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">nrow</span>(df2020)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; [1] 42</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>Nlinks</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#&gt; [1] 27</span></span></code></pre></div>
<p>We can look at the level of agreement of the <strong>PIVs</strong> in
the set of true links, and the proportion of missing values:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">colSums</span>(df2016[TrueDelta[,<span class="dv">1</span>],PIVs] <span class="sc">==</span> df2020[TrueDelta[,<span class="dv">2</span>],PIVs]) <span class="sc">/</span> Nlinks</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#&gt;    ANASCI     SESSO    STACIV    STUDIO      IREG </span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#&gt; 1.0000000 1.0000000 0.9259259 0.7777778 1.0000000</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(df2016[TrueDelta[,<span class="dv">1</span>],PIVs])) <span class="sc">/</span> Nlinks</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#&gt; ANASCI  SESSO STACIV STUDIO   IREG </span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#&gt;      0      0      0      0      0</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(df2020[TrueDelta[,<span class="dv">2</span>],PIVs])) <span class="sc">/</span> Nlinks</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co">#&gt; ANASCI  SESSO STACIV STUDIO   IREG </span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">#&gt;      0      0      0      0      0</span></span></code></pre></div>
<p><code>FlexRL</code> needs a specific encoding of the data to run
properly. The categorical observed values in the data should be mapped
to the set of natural numbers; missing values should be encoded as 0.
The algorithm requires a column “source” and, it denotes by B the
biggest data set.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>df2016<span class="sc">$</span>source <span class="ot">=</span> <span class="st">&quot;df2016&quot;</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>df2020<span class="sc">$</span>source <span class="ot">=</span> <span class="st">&quot;df2020&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(df2020)<span class="sc">&gt;</span><span class="fu">nrow</span>(df2016)){</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  encodedA <span class="ot">=</span> df2016</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  encodedB <span class="ot">=</span> df2020</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;df2020 is the largest file, denoted encodedB&quot;</span>)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  encodedB <span class="ot">=</span> df2016</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  encodedA <span class="ot">=</span> df2020</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;df2016 is the largest file, denoted encodedB&quot;</span>)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="co">#&gt; df2016 is the largest file, denoted encodedB</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>levels_PIVs <span class="ot">=</span> <span class="fu">lapply</span>(PIVs, <span class="cf">function</span>(x) <span class="fu">levels</span>(<span class="fu">factor</span>(<span class="fu">as.character</span>(<span class="fu">c</span>(encodedA[,x], encodedB[,x])))))</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(PIVs))</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>{</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  encodedA[,PIVs[i]] <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(<span class="fu">as.character</span>(encodedA[,PIVs[i]]), <span class="at">levels=</span>levels_PIVs[[i]]))</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  encodedB[,PIVs[i]] <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(<span class="fu">as.character</span>(encodedB[,PIVs[i]]), <span class="at">levels=</span>levels_PIVs[[i]]))</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>}</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>nvalues <span class="ot">=</span> <span class="fu">sapply</span>(levels_PIVs, length)</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="fu">names</span>(nvalues) <span class="ot">=</span> PIVs</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>encodedA[,PIVs][ <span class="fu">is.na</span>(encodedA[,PIVs]) ] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>encodedB[,PIVs][ <span class="fu">is.na</span>(encodedB[,PIVs]) ] <span class="ot">=</span> <span class="dv">0</span></span></code></pre></div>
<p>The number of unique values per <strong>PIV</strong> gives
information on their discriminative power:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>nvalues</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#&gt; ANASCI  SESSO STACIV STUDIO   IREG </span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#&gt;     28      2      4      5      1</span></span></code></pre></div>
<p>We can now launch <code>FlexRL</code>:</p>
<p>We elaborate on all the parameters below.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">list</span>( <span class="at">A                    =</span> encodedA,</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>             <span class="at">B                    =</span> encodedB, </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>             <span class="at">Nvalues              =</span> nvalues,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>             <span class="at">PIVs_config          =</span> PIVs_config,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>             <span class="at">controlOnMistakes    =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>             <span class="at">sameMistakes         =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>             <span class="at">phiMistakesAFixed    =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>             <span class="at">phiMistakesBFixed    =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>             <span class="at">phiForMistakesA      =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>             <span class="at">phiForMistakesB      =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>             )</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>fit <span class="ot">=</span> FlexRL<span class="sc">::</span><span class="fu">stEM</span>(  <span class="at">data                 =</span> data,</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>             <span class="at">StEMIter             =</span> <span class="dv">50</span>,</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>             <span class="at">StEMBurnin           =</span> <span class="dv">30</span>,</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>             <span class="at">GibbsIter            =</span> <span class="dv">100</span>, </span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>             <span class="at">GibbsBurnin          =</span> <span class="dv">70</span>,</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>             <span class="at">musicOn              =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>             <span class="at">newDirectory         =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>             <span class="at">saveInfoIter         =</span> <span class="cn">FALSE</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>             )</span></code></pre></div>
<ul>
<li><p>A</p></li>
<li><p>B</p></li>
<li><p>Nvalues</p></li>
<li><p>PIVs_config</p></li>
<li><p>controlOnMistakes</p></li>
<li><p>sameMistakes</p></li>
<li><p>phiMistakesAFixed</p></li>
<li><p>phiMistakesBFixed</p></li>
<li><p>phiForMistakesA</p></li>
<li><p>phiForMistakesB</p></li>
<li><p>newDirectory</p></li>
<li><p>data</p></li>
<li><p>StEMIter</p></li>
<li><p>StEMBurnin</p></li>
<li><p>GibbsIter</p></li>
<li><p>GibbsBurnin</p></li>
<li><p>sparseOutput</p></li>
<li><p>musicOn</p></li>
<li><p>newDirectory</p></li>
<li><p>saveInfoIter</p></li>
</ul>
<p>The algorithm returns:</p>
<ul>
<li><p>Delta</p></li>
<li><p>gamma</p></li>
<li><p>eta</p></li>
<li><p>alpha</p></li>
<li><p>phi</p></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>DeltaResult <span class="ot">=</span> fit<span class="sc">$</span>Delta</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">colnames</span>(DeltaResult) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;idx20&quot;</span>,<span class="st">&quot;idx16&quot;</span>,<span class="st">&quot;probaLink&quot;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>DeltaResult <span class="ot">=</span> DeltaResult[DeltaResult<span class="sc">$</span>probaLink<span class="sc">&gt;</span><span class="fl">0.5</span>,]</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>DeltaResult</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">#&gt;    idx20 idx16 probaLink</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#&gt; 1      1     1     0.970</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co">#&gt; 3     21     3     0.616</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co">#&gt; 4      4     4     0.970</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="co">#&gt; 6     38     7     0.789</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co">#&gt; 10    31    11     0.503</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co">#&gt; 11     6    14     0.991</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">#&gt; 12     7    15     0.898</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#&gt; 13     8    16     0.962</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">#&gt; 14     9    17     0.970</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co">#&gt; 15    10    18     0.974</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co">#&gt; 16    11    19     0.992</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co">#&gt; 17    12    20     0.980</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co">#&gt; 18    36    21     0.587</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">#&gt; 19    13    22     0.937</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">#&gt; 20    14    23     0.957</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">#&gt; 21    15    24     0.991</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="co">#&gt; 26    42    29     0.672</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; 27    24    30     0.776</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="co">#&gt; 29    19    34     0.951</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="co">#&gt; 30    30    36     0.984</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">#&gt; 31    20    37     0.860</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">#&gt; 32     3    38     0.612</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">#&gt; 34     5    39     0.524</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="co">#&gt; 37     2    41     0.730</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="co">#&gt; 39    26    43     0.879</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="co">#&gt; 45    28    46     0.815</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="co">#&gt; 46    29    48     0.515</span></span></code></pre></div>
<p>We can then compare the linked records with the true links:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">Results=</span><span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span><span class="dv">6</span>, <span class="at">ncol=</span><span class="dv">1</span>) )</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="fu">rownames</span>(results) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>,<span class="st">&quot;f1score&quot;</span>,<span class="st">&quot;fdr&quot;</span>,<span class="st">&quot;sens.&quot;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(DeltaResult)<span class="sc">&gt;</span><span class="dv">1</span>){ </span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  linked_pairs    <span class="ot">=</span> <span class="fu">do.call</span>(paste, <span class="fu">c</span>(DeltaResult[,<span class="fu">c</span>(<span class="st">&quot;idx16&quot;</span>,<span class="st">&quot;idx20&quot;</span>)], <span class="fu">list</span>(<span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  truepositive    <span class="ot">=</span> <span class="fu">length</span>( <span class="fu">intersect</span>(linked_pairs, true_pairs) ) </span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  falsepositive   <span class="ot">=</span> <span class="fu">length</span>( <span class="fu">setdiff</span>(linked_pairs, true_pairs) ) </span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>  falsenegative   <span class="ot">=</span> <span class="fu">length</span>( <span class="fu">setdiff</span>(true_pairs, linked_pairs) ) </span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  precision       <span class="ot">=</span> truepositive <span class="sc">/</span> (truepositive <span class="sc">+</span> falsepositive) </span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  fdr             <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> precision</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>  sensitivity     <span class="ot">=</span> truepositive <span class="sc">/</span> (truepositive <span class="sc">+</span> falsenegative) </span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>  f1score         <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> sensitivity) <span class="sc">/</span> (precision <span class="sc">+</span> sensitivity)</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>  results[,<span class="st">&quot;FlexRL&quot;</span>] <span class="ot">=</span> <span class="fu">c</span>(truepositive,falsepositive,falsenegative,f1score,fdr,sensitivity)</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>}</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>results</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co">#&gt;         Results     FlexRL</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="co">#&gt; tp           NA 17.0000000</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="co">#&gt; fp           NA 10.0000000</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="co">#&gt; fn           NA 10.0000000</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="co">#&gt; f1score      NA  0.6296296</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="co">#&gt; fdr          NA  0.3703704</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="co">#&gt; sens.        NA  0.6296296</span></span></code></pre></div>
<p>The level of agreement among the linked records differs from the one
in the true links:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">colSums</span>(encodedA[DeltaResult[,<span class="st">&quot;idx20&quot;</span>],PIVs] <span class="sc">==</span> encodedB[DeltaResult[,<span class="st">&quot;idx16&quot;</span>],PIVs]) <span class="sc">/</span> <span class="fu">nrow</span>(DeltaResult)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">#&gt;    ANASCI     SESSO    STACIV    STUDIO      IREG </span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">#&gt; 1.0000000 0.8888889 0.9629630 1.0000000 1.0000000</span></span></code></pre></div>
<p>The missing values and potential mistakes in the registration, the
size of the overlapping set of records between the files, the
instability of some <strong>PIVs</strong>, their distribution, and
dependencies among them, are obstacles to the linkage.</p>
<p>Several other algorithms for <strong>R</strong>ecord
<strong>L</strong>inkage have been developed so far in the literature.
We cite some of them in our <a href="https://arxiv.org/abs/2407.06835">paper</a> but more can be found.
Each has its own qualities and flaws. <code>FlexRL</code> usually
outperforms in scenarios where the <strong>PIVs</strong> have low
discriminative power with few expected registration errors; it is
particularly efficient when there is enough information to model
instability of some <strong>PIV</strong> changing across time (such as
the postal code). More can be found on this topic in the simulation
setting of the paper, which is provided in <a href="https://github.com/robachowyk/FlexRL-experiments"><code>FlexRL-experiments</code></a>.</p>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
